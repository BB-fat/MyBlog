---
title: 点滴校园制作心得
date: 2019-05-31 10:05:01
tags:
---

# 前言
## 项目背景
“点滴校园”这个项目其实是在18年开始的，当时也是一个h5，是学校找外面的公司做的，看起来真的很一般，但是因为内容很有趣，很多人转发。  
我其实早就想做这个东西，接手这个项目的前一天还和队员们聊过如果能做这个会很有趣，结果第二天梦想就成真了，激动过后发现时间很紧，距离文艺毕晚只有两周，如果想获得最好的效果就得在毕晚发票之前上线，实际开发时间只有一周半。
## 团队组建
团队中没有懂h5开发的，在朋友圈发了一下然后私下找了几个人，但是没有合适的，由于时间紧迫，我决定和王文徽一起现学现用。设计我找了老部长杨薇，她技艺高超，然后黄鹏嘉也愿意加入，文案找了林洪艺，这样OneTech“点滴校园”项目组就组建完成了。
## 整体思路  
之前写小程序接触过一些javascript，但是没有系统的学过，对h5本身更是没有什么了解，所以基本上是跳过了学习直接上项目，而且时间很紧，一开始看来是个不可能完成的任务，甚至不知从何下手。冷静下来理一理思路，这种数据展示类的h5一定是需要渲染上数据的，那么如何获取数据呢？我想到两个办法：  
1、后端做好接口，使用js请求数据。  
2、在后端直接用模版引擎渲染html。  
为了保护数据，我肯定不能在js里暴露接口，所以使用模版引擎就是最好的选择。  
数据获取方式打算直接使用小程序的用户认证，正好顺便推广“我的北方”。  
那么接下来就开干吧，车到山前必有路。
# 小程序
当时还有一个很紧迫的问题：我的北方还没有完成测试，测试完成后上线审核不知道需要多长时间，所以我必须抓紧时间完成小程序端点滴校园的开发。考虑到有可能一些用户是第一次进入“我的北方”所以我还需要考虑数据库中没有用户信息的情况，最后决定做一个“点滴校园”特色的认证界面。
## 入口
![image.png](https://img.hacpai.com/file/2019/05/image-a87a102e.png)
这个具体对接后端的逻辑到不是很复杂，两种情况：  
1、用户已经认证过，直接跳转到h5。  
2、用户没有认证过，显示认证界面，引导其认证。  
对应到后端就是两个路由。
## 上线
由于“我的北方”的认证主体是北方工业大学，为政府单位，所以代码审核速度异常迅速，我们设计有一个认证机制，将非我校用户拦截在程序外，本以为微信会向我们索要测试账号，我们也都已经准备好了，但结果代码提交审核后一个小时就通过了，而且后面几次提交都是如此，审核过程异常顺利，这也让我在“点滴校园”上线之前能有时间为其单独订做一个入口，也就是首页的小飞机。
## 系统差别
当时我的设计思路是通过小程序码直接进入点滴校园的认证界面然后运行逻辑引导用户进入点滴校园，当时用IOS系统测试是完全可行的，每次扫描那个特定的小程序码都可以进入指定界面，但是上线之前发现安卓系统中这种方式只能成功一次，在小程序未开启的时候用户扫码可以正常进入，但当小程序在后台挂载的时候，扫描那个小程序码只能拉起小程序，但并不会跳转到指定页面。  
这个问题会导致用户体验下降，很多用户进入一次之后还想再看一遍，但是因为这个问题它没办法返回。  
所以这迫使我必须做一个点滴校园的入口。
# 服务端
小程序服务端使用python 的 flask轻量web框架，配有jinja2模版引擎，使用MVC架构设计。
## 静态文件
flask框架配有静态文件目录，路径为**app同级**的**static**目录下。  
访问路由为
```
/static
```
有一个可以动态生成这种静态路由的函数 **url_for()** 而且该函数还可以嵌套在html中直接使用，具体用法如下：
```
url_for("static",filename="style.css")
```
这里的style.css文件可以对应/static/style.css  
但是由于我们这个项目的路由相对简单，所以不需要来回书写这么复杂的函数，直接写相对路径即可，在这里是：
```
/static/schoolLife2019/js/main.js
```
这样可以引导客户端请求需要的静态文件。
## 模版语法
模版引擎为jinja2。
### 数据绑定
服务端使用模版渲染函数时传入相应的数据：
```
return render_template("2019SchoolLife.html", data=data)
```
其中数据存储在data字典中，在html中调用的方式：
```
1.  <div class="page0-count-div">
2.  	你是第<em>{{data.count}}</em>个打开这份记录的人
3.  </div>
```
其中data字典中的count值就会被渲染入em标签中。
### 条件渲染
为了根据个人的数据做更准确的文案匹配，我们使用了条件渲染。
```
1.  <div class="page3-text-div">
2.  一定是特别的缘分，<br>
3.  {%if data.same_name!=0%}
4.  学校一共有<em>{{data.same_name}}</em>人与你同名同姓。<br>
5.  {%else%}
6.  你是全校唯一一个叫做<em>{{data.name}}</em>的人。<br>
7.  {%endif%}
8.  <br>学校一共有<em>{{data.same_day_school}}</em>人与你同一天出生。<br>
9.  {%if data.same_day_and_year!=0%}
10.  <br>其中有<em>{{data.same_day_and_year}}</em>人与你同年同月同日。<br>
11.  {%endif%}
12.  <br>期待在一个玉兰花开的日子里，与 ta 相识。
13.  </div>
```
jinja2中的条件语句需要被 **{% %}** 包裹，并且在if语句块的最后需要有 **{%endif%}** 用来表示条件渲染的结束，中间允许出现多个 **{%elif <表达式>%}** 。  
以上这段代码展示了两次条件渲染的运用，第一次判断全校是否有与你同名同姓的人，第二次判断全校是否有和你同年同月同日生的人。
### 列表渲染
```
1.  <div id="tagbox">
2.  {% for i in data.msgs %}
3.  <a class="group">
4.  <img src="{{i.img}}" class="img"></img>
5.  {{i.msg}}
6.  </a>
7.  {% endfor %}
8.  </div>
```
这部分代码是在加载评论球中的数据，写法和条件渲染类似，data.msgs是一个字典列表，通过for循环遍历在相应的位置安放img（用户头像）和msg（评论信息）。
# 数据库
## Oracle
h5展示的数据来源于学校的	Oracle数据库，老师给我们的方案是，通过特殊授权的账号直接访问数据库，使用查询语句获取数据。  
Oracle需要通过客户端连接数据库，所以第一步就是安装配置Oracle客户端，惭愧的是，这一步我通宵一个晚上都没有搞定，后来求助籍大哥，他的代码给了我一些启发，最后成功连接了数据库。具体的步骤我已经记录下来了，参见另一篇文章：[Linux安装Oracle client](http://www.fatech.online:8080/articles/2019/05/20/1558294463267.html)
## MongoDB
“我的北方”使用MongoDB作为唯一数据库。
### 统计访问位次
使用了两个集合，其中一个集合之中只有一个文档，负责记录当前访问人数。另一个集合负责持续写入新的访问数据。
```
{
    "_id" : ObjectId("5ce9586e9dc6d63064931078"),
    "userid" : "17152010921",
    "count" : 1
}
```
count记录访问者的排名，当用户再次进入“点滴校园”之后就会显示他原本的排名。  
### 评论模块的实现
“点滴校园”中有一个有趣的评论模块，它的逻辑是：用户每次访问只能发送一条评论，每次访问会随机看到30条其他用户的评论。  
数据库中实现随机的方法是在集合长度范围内生成随机数，然后控制游标跳过该随机数，然后取一个元素。其实这种办法比较消耗性能，但是我们的数据库性能过剩，所以也就无所谓了。
# H5
之前说过了，我和王文徽一点都不懂h5，我们俩从项目需求出发，一点一点攻克难关。
## 翻页
这种数据展示类的h5需要一页页翻页，王文徽先去网上找了几个h5，我们看他们的代码，发现翻页控制实际上是由特定的js库然后以特定格式书写html标签实现的。我们便效仿这种方式，在正式开发的第一天晚上，利用islider成功实现了一个简单的demo。   
**那天晚上真的是很难忘，我们在肯德基通宵，我们俩真的很有干劲，每一次有所突破都像打了肾上腺素一样。等到早晨外面还下起了雨，回去的路上把鞋子全都弄湿了。这是那一周4次通宵的第一次。**  
但是islider有很多问题：  
1、在微信环境下下拉上滑页面的时候整个页面会晃动，露出域名。  
**2、islider的回调函数太少了，只有两个：开始滑动和滑动完成。无法满足我们的需求。**  
所以我需要寻找另一个能控制翻页的框架替代islider，我找到了[swiper](https://www.swiper.com.cn)。
swiper功能强大、中文文档完善、使用方法简单，可以满足我们的项目需求。
### swiper初始化
```
<script> 
var mySwiper = new Swiper('.swiper-container', { 
		autoplay: true,//可选选项，自动滑动 
	})
</script>
```
直接创建对象即可，具体参数见
https://www.swiper.com.cn/api/start/new.html
### 编码页面
swiper控制区域的最外层是class为 **swiper-container** 的div标签，内套一个class为 **swiper-wrapper** 的标签，然后每一页是一个class为 **swiper-slide** 的标签，每个页面的内容就写在其中。
```
1.  <!-- 第一页-->
2.  <div class="swiper-slide page0">
3.  <img class="stone" src="static/2019SchoolLife/img/1-stone.png">
4.  <img class="bgimg" src="static/2019SchoolLife/img/background.png">
5.  <div class="page0-count-div">
6.  你是第<em>{{data.count}}</em>个打开这份记录的人
7.  </div>
8.  <div class="page0-text-div">
9.  工大不大 , 四年却很长<br>
10.  <p>足够你用脚印丈量每一段距离;</p>
11.  工大很大 , 但四年不长<br>
12.  <p>等待你将生活在这里的每一刻细细品尝</p>
13.  时光肆意流 , 工大点滴留<br>
14.  你和工大的故事还在记录着<br>
15.  <p>...</p>
16.  点滴校园 , 时间看得见
17.  </div>
18.  </div>
```
这样就完成了第一页。
## Swiper回调函数
Swiper有很多回调函数。
官方文档：https://www.swiper.com.cn/api/event/84.html
我们主要使用slideChange函数，该函数在页面切换结束时会被调用，通过内置的activeIndex变量可以确定当前是哪个页面，由此可以控制该页面的相关动画。
通过touchStart和touchEnd函数控制屏幕下方的小人的动作（静态图片和动态图片的切换）。
这样我们算是可以写基本的页面了。
## Move.js
这个库是我们实现文字动画的主要工具。
之所以选择Move.js是因为它操作极其简单，就是用js操作css加上延时就能生成动画，王文徽在KFC刷夜的时候研究了另一个更绚丽的文字动画，但是由于项目排期很短，那个动画在实际应用的时候特别麻烦，所以最后放弃了。
```
move(".page"  +  this.activeIndex  +  "-text-div")
	.set('opacity', '1')
	.duration("5s")
	.end()
```
以上代码就可以产生“点滴校园”中浮现文字的效果。
## Fly.js
这是一个封装的js请求包，其实js中直接用XHR请求也不是很麻烦，但我当时并不会这个，所以在网上搜到了这个更简单的。
以下是提交评论的接口
```
btn_submit.onclick  =  function () {
	fly.get("/接口路由", {
		msg:  input.value,
		userid:userid
	})
	.then(function () {
		alert("留言成功")
		input.disabled=true
		btn_submit.hidden=true
	})
}
```
一看就明白，非常简单。但是后期上线之后发现了问题，**IOS微信环境下不支持Fly.js**。所以在最后统计引流能力的时候是按照IOS安卓用户比去计算的。
## 音乐自动播放
这一块当时也算是个坎，王文徽花了些精力才解决，这里我只是简单了解了一下原理，具体的代码是他的。
在微信环境下加载h5audio组件是不能使用autoplay的，需要引入一个微信的官方SDK监视h5加载完成才能开始播放音乐，在这之前用js控制播放也是不行的。
```
wx.ready(function () {
	$audio.play();
});
```
## Canvas生成海报
这里在当时是一个巨大的技术难题，我们俩轮番上阵好久都没有搞定，最后我发现是我们的思路从一开始就有问题，我们有过下面几个思路：
显示绘制的海报然后点击按钮将其中的内容转换成图片并弹出保存图片的按钮（不可行）
显示绘制的海报然后点击按钮生成图片的Base64字串并跳转（用户体验较差）
最后选择通过js操控Canvas绘图之后直接生成Base64字串，然后将其赋值给img标签的src属性。为了获取计数器的个数，我选择在H5模版中通过模版语法将js的数据写入。
```
// 控制渲染分享海报

function  makePic(img_url, text) {

var  img  =  new  Image()

img.src  =  img_url;

img.onload  =  function () {

var  myCanvas  =  document.createElement("canvas")

myCanvas.width  =  img.width;

myCanvas.height  =  img.height;

var  ctx  =  myCanvas.getContext("2d")

ctx.drawImage(img, 0, 0);

ctx.font  =  "38px Arial";

ctx.fillText("我是第"+count+"个打开这份记录的人", 135, 185);

ctx.font  =  "35px Arial";

var  y  =  350

for (var  i  =  0; i  <  text.length; i++) {

ctx.fillText(text[i], 60, y);

y  +=  80

}

var  url  =  myCanvas.toDataURL("image/png", 1)

document.getElementById("share-img").src  =  url

}

}
```
```
var count={{data.count}}
```
main.js放在文件的最后引入。
```
<script src="static/2019SchoolLife/js/main.js"></script>
````
这样在main.js中就直接可以使用count变量。
海报上的文案是一个字符串列表，也是通过这种方式将数据传进去的，下面展示一部分文案代码。
```
var shareList=[

{

img:"static/2019SchoolLife/img/share1.png",

text: [

"我来自{{data.city}}，",

"全校一共有{{data.same_name_school}}和我来自同一个地方，",

"相处这么久，",

"我才知道还有{{data.same_day_and_year}}人和我同年同月同日生，",

{%if data.same_name!=0%}

"也才知道，尽然有{{data.same_name}}人和我同名同姓，",

{%if data.userid[:2]=="15"%}

"如果还有时间，我真想和他们认识。",

{%endif%}

{%else%}

"但我的名字在校园中却是独一无二的。",

{%endif%}

]

},
```
这就是第一页的数据，其中运用了jinja2的条件渲染。
这里有一个需要注意的点，需要先操控Canvas绘制图片然后再绘制文字，但是Canvas绘制图片需要时间，这个过程很有可能因为js的异步特性失败。
所以这里需要把后续执行的代码放在绘制图片的onload回调中。
## 其他炫酷的组件
开发过程中，为了产品的效果最优，我们选取了一些现成的组件，其中包括两个图表和一个评论球。效果还是很不错的，但我们并不明白其背后的工作原理。
![IMG0107.PNG](https://img.hacpai.com/file/2019/06/IMG0107-e01629b9.PNG)
![IMG0108.PNG](https://img.hacpai.com/file/2019/06/IMG0108-949049d4.PNG)
![IMG0109.PNG](https://img.hacpai.com/file/2019/06/IMG0109-321b89c7.PNG)
# 上线推广
我的计划原本是这样的：先悄悄更新小程序，一定会有人发现这个活动，然后观察访问量，等到晚上再于朋友圈大幅扩散。
我是在下午2点半左右上线的点滴校园，这是当天的访问量折线图。
![IMG1056.jpg](https://img.hacpai.com/file/2019/06/IMG1056-49726af4.jpg)
当天的访问量就有将近7万，当时的确是很激动，毕竟是第一次做出来上线的产品，而且在校内非常流行。
**最后全校总共有6270人使用过“点滴校园”，给校文艺部毕晚推送引流1300+，总访问量9w+，这9w包括了非我校学生打开小程序的无效流量，但是这也是一个很大的数字了，“点滴校园”大获成功。**
后来在晚上8点中左右，我们又动用了学生会的力量进行了推广，但是数据增幅并不是很明显，这说明在这之前用户的覆盖率已经很高了。
# 刷夜心得
之前说过，这个项目的排期很紧，所以我不得已连续刷了4天夜，这里得特别感谢校会的老朋友们，他们允许我们在校会一起刷夜。
刷的时候喝几罐功能饮料，到上午10点都还不困，但是能明显感觉到反应速度下降，那一周过去之后非常疲惫，也许持续了两周才完全恢复，所以正常的作息是很重要的。
# 存在的问题
由于是第一次以产品上线为目的做项目，所以踩了很多的坑，不过我视这为学习的过程在这个过程中，我主要犯了两个错误。
## 评论审核
评论球我预先向其中存放了170条评论，每个用户随机取30条查看，每个用户每一次打开只能评论一条，在策划这个模块的时候我也考虑过评论审核的问题，但是我选择相信人性中善良的一面，没有加入评论审核机制，所有发出来的评论直接写入数据库。
但是，当天晚上马老师就发现了一些不和谐的声音，连续11条“xxx必死”出现在了数据库中。我和男哥紧急排查，清除了这些不当言论，第二天我就上线了一个带有封禁功能的版本，然后把涉事人员封禁了。在晚上的决策层讨论会上，我把这个问题抛了出来，几个项目经理和设计都觉得不应该直接封禁，这样会显得我们是“权限狗”。所以我解除了对他们的封禁。
后来我担心再出问题，所以我多次查看评论数据库，并没有再发现这种不当言论，这样看来当初我选择相信同学们不会把这里当成贴吧的决定是基本正确的，只不过，还是应该留一个心眼。
## Bug
“点滴校园”的bug都是数据格式引发的问题，有些人没有在学校的浴室刷过卡，有些人没有使用过“多模式教学网”，有些特殊身份的学生没有“第一门课”的数据。。。
这些问题的出现表明我们在测试的时候样本选取的不够全，没有考虑到这么多情况，虽然最后做了一些补救，但还是有一些研究生学长学姐不能使用，下一次我会提前准备，并且扩大测试群体，让每个人都能用上“点滴校园”。
# 总结
“我的北方”和“点滴校园”是我完成的第一个正式上线的产品，而且全程由我带领OneTech团队开发完成，我非常开心，团队中的每个人也都很棒。和一群很有想法的人一起做事真有意思。这之间我们也有过分歧、也走过弯路，不过最后我们完成了产品并学到了很多东西。
这篇七零八散的日志耗时一周才写完，今天正好是我转入计算机科学与技术系的一周年，这一年也算是完成了自我的转变，也学到了很多知识，找对了前进的方向，“口袋发票”、“我的北方”、“点滴校园”，也算是收获满满，新的一年，BBfat继续走下去！
